{% extends 'base.html' %}
{% load humanize %}
{% load cache %}
{% load static %}
{% load module_stats %}

{% block title %}{{ module_type.name }}{% endblock %}

{% block content %}

<style>
    {% for at in attributes %}
    .attr-{{ at.id }}:after {
        content: " {{ at.unit_str }}";
    }
    {% endfor %}
</style>

{% include "abyssal_modules/module_tabs.html" with active_page="asset_list" %}

<div class="jumbotron jumbotron-tabs">
    <h1>{{ module_type.name }}</h1>

    <form>
        <div class="row">
            {% for at in attributes %}
            <div class="form-group col-12 col-md-6">
                <div class="row">
                    <label class="col-6"><img src="{% static at.icon_path %}" title="{{ at.name }}"> {{ at.name }}{% if at.derived %}<span style="text-muted" title="This is a derived attribute.">*</span>{% endif %}</label>
                    {% if at.high_is_good %}
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter negative" id="attr-{{ at.id }}-min" data-attr-modified="{{ at.id }}" step="0.0001">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter positive" id="attr-{{ at.id }}-max" data-attr-modified="{{ at.id }}" step="0.0001">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter positive" id="attr-{{ at.id }}-min" data-attr-modified="{{ at.id }}" step="0.0001">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter negative" id="attr-{{ at.id }}-max" data-attr-modified="{{ at.id }}" step="0.0001">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="row mt-2 px-4 slider-container">
                    <div id="attr-{{ at.id }}-range" class="col-12 slider-{{ at.high_is_good|yesno:'positive,negative' }}"></div>
                </div>
            </div>
            {% endfor %}
        </div>
    </form>
</div>

<div class="jumbotron">
    <table class="table module-table dt-responsive" id="module-table">
        <thead>
            <tr>
                <th width="1px">Icon</th>
                {% for at in attributes %}
                <th><img src="{% static at.icon_path %}" title="{{ at.name }}"></th>
                {% endfor %}
                <th width="0px">Actions</th>
            </tr>
        </thead>
    </table>
</div>
{% endblock %}

{% block trailing_js %}
<script>
    var table;
    var attr_val = {};
    var column_ids = {};
    var price_range;
    var module_type = {{ module_type.id }};
    var attr_list = [];

    {% for at in attributes %}
    attr_list.push({{ at.id }});
    {% endfor %}

    function icon_format(data) {
        if (!data.static) {
            return `<a href="/module/${data.id}/"><img src="https://image.eveonline.com/Type/${data.type_id}_32.png"></a>`
        } else {
            return `<img src="https://image.eveonline.com/Type/${data.id}_32.png" title="${data.module_name}">`
        }
    }

    $(".update-filter").change(function () {
        table.draw();
    });

    $(document).on("click", ".btn-open-contract-esi", function() {
        open_contract($(this));
    });

    $(document).on("change", ".module-attribute-filter", function() {
        var new_values;

        if (this.dataset.attrModified == 'price') {
            new_values = price_to_range([
                $(`#attr-price-min`).val() * 1000000,
                $(`#attr-price-max`).val() * 1000000,
            ], 100000);
        } else {
            new_values = [
                $(`#attr-${this.dataset.attrModified}-min`).val(),
                $(`#attr-${this.dataset.attrModified}-max`).val(),
            ];
        }

        $(`#attr-${this.dataset.attrModified}-range`).slider('values', new_values);
    });

    $(document).ready(function () {
        table = $('#module-table').DataTable({
            "processing": true,
            "ajax": {
                url: "{% url 'abyssal_api:asset_list' module_type.id %}",
                dataSrc: ''
            },
            "columns": [
                {
                    'name': 'id',
                    'orderable': false,
                    'data': null,
                    'render': function (data, type, row, meta) {
                        return icon_format(data);
                    }
                },
                {% for at in attributes %}
                {
                    'name': 'attr-{{ at.id }}',
                    'data': 'attributes.{{ at.id }}',
                    'type': 'num',
                    'render': {
                        'display': function (data, type, row, meta) {
                            return attr_format({{ at.id }}, data);
                        },
                        '_': 'real_value'
                    }
                },
                {% endfor %}
                {
                    'name': 'open',
                    'orderable': false,
                    'render': {
                        '_': function (data, type, row, meta) {
                            return open_format_non_contract(row);
                        }
                    }
                }
            ],
            "order": [[1, "asc"]],
            "initComplete": function(settings, json) {
                for (i = 0; i < attr_list.length; i++) {
                    at = attr_list[i];
                    data = table
                        .column(`attr-${at}:name`)
                        .data()
                        .map(function (n) { return n.real_value; })
                        .sort(function (a, b) { return a - b; });

                    attr_val[at] = [data[0], data.reverse()[0]];

                    if (at != 105) {
                        attr_val[at][0] -= (attr_val[at][0] < 0 ? -1 : 1) * attr_val[at][0] * 0.01;
                        attr_val[at][1] += (attr_val[at][1] < 0 ? -1 : 1) * attr_val[at][1] * 0.01;
                    }

                    column_ids[at] = table.column(`attr-${at}:name`).index();

                    $(`#attr-${at}-min`).attr('step', Math.pow(10, -get_precision(at)));
                    $(`#attr-${at}-max`).attr('step', Math.pow(10, -get_precision(at)));
                }

                table.draw();
                update_labels();

                for (i = 0; i < attr_list.length; i++) {
                    initialize_slider(attr_list[i]);
                }

                $.fn.dataTable.ext.search.push(
                    function (settings, data, dataIndex, original) {
                        var value, at;

                        for (i = 0; i < attr_list.length; i++) {
                            at = attr_list[i];

                            value = data[column_ids[at]];

                            if (value < attr_val[at][0] || value > attr_val[at][1]) {
                                return false;
                            }
                        }

                        return true;
                    }
                );

                table.draw();
            }
        });
    });

    function update_labels() {
        for (i = 0; i < attr_list.length; i++) {
            at = attr_list[i];

            $(`#attr-${at}-min`).val(attr_val[at][0].toFixed(get_precision(at)));
            $(`#attr-${at}-max`).val(attr_val[at][1].toFixed(get_precision(at)));
        }
    }

    function attr_slider_fun(event, ui, attr_id) {
        attr_val[attr_id] = ui.values;
    }

    function range_to_price(range, max) {
        var t = (price_range[1] / (max ** 3));

        return [(range[0] ** 3) * t, (range[1] ** 3) * t];
    }

    function price_to_range(price, max) {
        var t = (price_range[1] / (max ** 3));

        return [
            ((price[0] / t) ** (1.0 / 3.0)),
            ((price[1] / t) ** (1.0 / 3.0))
        ];
    }

    function price_slider_fun(event, ui, attr_id) {
        attr_val[attr_id] = range_to_price(ui.values, 100000);
    }

    function initialize_slider(attr_id) {
        var range;
        var values;
        var slide;

        if (attr_id == "price") {
            range = [0, 100000];
            values = [0, 100000];
            slide = price_slider_fun;
        } else {
            range = attr_val[attr_id];
            values = attr_val[attr_id];
            slide = attr_slider_fun;
        }

        $("#attr-" + attr_id + "-range").slider({
            range: true,
            min: range[0],
            max: range[1],
            step: 0.00001,
            values: values,
            slide: function (event, ui) {
                slide(event, ui, attr_id);
                update_labels();
            },
            change: function (event, ui) {
                slide(event, ui, attr_id);
                update_labels();
                table.draw();
            }
        });
    }


</script>
{% endblock %}
