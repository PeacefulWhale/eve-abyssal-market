{% extends 'base.html' %}
{% load humanize %}
{% load cache %}
{% load static %}
{% load module_stats %}

{% block title %}{{ module_type.name }}{% endblock %}

{% block content %}

<style>
    {% for at in attributes %}
    .attr-{{ at.id }}:after {
        content: " {{ at.unit_str }}";
    }
    {% endfor %}
</style>

<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link active" href="#">Sell Orders</a>
    </li>
    <li class="nav-item">
        <a class="nav-link disabled" href="#" title="Coming soon!">Buy Orders</a>
    </li>
    <li class="nav-item">
        <a class="nav-link disabled" href="#" title="Coming soon!">Your Modules</a>
    </li>
</ul>

<div class="jumbotron jumbotron-tabs">
    <h1>{{ module_type.name }}</h1>

    <form>
        <div class="row">
            <div class="form-group col-12 col-md-6">
                <div class="row">
                    <label class="col-6"><img src="{% static "img/attributes/price.png" %}" title="Price"> Price</label>
                    <span class="col-3 attr-price" id="attr-price-min"></span>
                    <span class="col-3 attr-price" id="attr-price-max"></span>
                </div>
                <div class="row mt-1 px-4">
                    <div id="attr-price-range" class="slider-neutral col-12"></div>
                </div>
            </div>
            {% for at in attributes %}
            <div class="form-group col-12 col-md-6">
                <div class="row">
                    <label class="col-6"><img src="{% static at.icon_path %}" title="{{ at.name }}"> {{ at.name }}{% if at.derived %}<span style="text-muted" title="This is a derived attribute.">*</span>{% endif %}</label>
                    {% if at.high_is_good %}
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter negative" id="attr-{{ at.id }}-min" step="0.1" data-attr-modified="{{ at.id }}">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter positive" id="attr-{{ at.id }}-max" step="0.1" data-attr-modified="{{ at.id }}">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter negative" id="attr-{{ at.id }}-min" step="0.1" data-attr-modified="{{ at.id }}">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    <div class="input-group input-group-sm col-3">
                        <input type="number" class="form-control form-control-sm module-attribute-filter positive" id="attr-{{ at.id }}-max" step="0.1" data-attr-modified="{{ at.id }}">
                        <div class="input-group-append module-stat-unit">
                            <span class="input-group-text">{{ at.unit_str }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="row mt-1 px-4">
                    <div id="attr-{{ at.id }}-range" class="col-12 slider-{{ at.high_is_good|yesno:'positive,negative' }}"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        <br>
        <div class="row">
            <div class="col-3">
                <input type="checkbox" name="filter-show-auctions" class="update-filter" checked> Show auctions
            </div>
            <div class="col-3">
                <input type="checkbox" name="filter-show-multi-item" class="update-filter" checked> Show multi-item contracts
            </div>
            <div class="col-3">
                <input type="checkbox" name="filter-show-plex" class="update-filter" checked> Show contracts for PLEX
            </div>
        </div>
    </form>
</div>

<div class="jumbotron">
    <table class="table module-table dt-responsive" id="module-table">
        <thead>
            <tr>
                <th width="1px">Icon</th>
                {% for at in attributes %}
                <th><img src="{% static at.icon_path %}" title="{{ at.name }}"></th>
                {% endfor %}
                <th>Price</th>
                <th width="0px">Actions</th>
                <th>Auction</th>
                <th>Multi-item</th>
            </tr>
        </thead>
    </table>
</div>
{% endblock %}

{% block trailing_js %}
<script>
    var table;
    var attr_val = {};
    var column_ids = {};
    var price_range;
    var module_type = {{ module_type.id }};
    var attr_list = [];

    {% if not request.user.is_authenticated %}
    var logged_in = false;
    {% else %}
    var logged_in = true;
    {% endif %}

    {% for at in attributes %}
    attr_list.push({{ at.id }});
    {% endfor %}

    function display_rating(attr) {
        if (attr == 1255) {
            return false;
        } else if (attr == 105) {
            return false;
        } else {
            return true;
        }
    }

    function price_format(contract) {
        base = ""

        if (contract.price.isk > 0 && contract.price.plex > 0) {
            base += `<span class="price-field">${price_humanize_verbose(contract.price.isk)}</span> + <span class="plex-field">${price.plex}</span>`;
        } else if (contract.price.plex > 0) {
            base += `<span class="plex-field">${contract.price.plex}</span>`;
        } else {
            base += `<span class="price-field">${price_humanize_verbose(contract.price.isk)}</span>`;
        }

        if (contract.multi_item) {
            base += `<span class="annotation-multi-item text-muted" title="This contract includes other items."></span>`
        }

        if (contract.auction) {
            base += `<span class="annotation-auction text-muted" title="This is an auction."></span>`
        }

        return base;
    }

    function icon_format(mid) {
        return `<a href="/module/${mid}/"><img src="https://image.eveonline.com/Type/${module_type}_32.png"></a>`
    }

    function attr_format(attr, data) {
        base = `<span class='attr-${attr}'>${data.real_value.toFixed(get_precision(attr))}</span>`;

        if (data.rating != null && display_rating(attr)) {
            if (data.rating > 0) {
                base += ` <span class="module-rating text-success">+${data.rating}</span>`;
            } else if (data.rating == 0) {
                base += ` <span class="module-rating text-warning">Â±${data.rating}</span>`;
            } else {
                base += ` <span class="module-rating text-danger">${data.rating}</span>`;
            }
        }

        return base;
    }

    function open_format(mod, logged_in) {
        return `<div class="btn-group" role="group" aria-label="Basic example">
                    <button ${logged_in ? "" : "disabled"} class="btn btn-std-size btn-primary btn-open-contract-esi btn-open-contract" data-contract-id="${mod.contract.id}">ESI</button>
                    <button class="btn btn-std-size btn-primary btn-copy btn-copy-contract-link btn-open-contract" data-clipboard-text="<url=contract:30000142//${mod.contract.id}>Contract ${mod.contract.id}</url>">Link</button>
                    <button class="btn btn-std-size btn-primary btn-copy" data-clipboard-text="${mod.pyfa}">Pyfa</button>
                </div>`
    }

    $(".update-filter").change(function () {
        table.draw();
    });

    $(document).on("click", ".btn-open-contract-esi", function() {
        open_contract($(this));
    });

    $(document).on("change", ".module-attribute-filter", function() {
        $(`#attr-${this.dataset.attrModified}-range`).slider('values', [
            $(`#attr-${this.dataset.attrModified}-min`).val(),
            $(`#attr-${this.dataset.attrModified}-max`).val(),
        ]);
    });

    $(document).ready(function () {
        table = $('#module-table').DataTable({
            "processing": true,
            "ajax": {
                url: "{% url 'abyssal_api:module_list' module_type.id %}",
                dataSrc: ''
            },
            "columns": [
                {
                    'name': 'id',
                    'orderable': false,
                    'data': 'id',
                    'render': function (data, type, row, meta) {
                        return icon_format(data);
                    }
                },
                {% for at in attributes %}
                {
                    'name': 'attr-{{ at.id }}',
                    'data': 'attributes.{{ at.id }}',
                    'type': 'num',
                    'render': {
                        'display': function (data, type, row, meta) {
                            return attr_format({{ at.id }}, data);
                        },
                        '_': 'real_value'
                    }
                },
                {% endfor %}
                {
                    'name': 'price',
                    'data': 'contract',
                    'type': 'num',
                    'render': {
                        'display': function (data, type, row, meta) {
                            return price_format(data);
                        },
                        '_': 'price.total',
                    }
                },
                {
                    'name': 'open',
                    'orderable': false,
                    'render': {
                        '_': function (data, type, row, meta) {
                            return open_format(row, logged_in);
                        }
                    }
                },
                {
                    'name': 'auction',
                    'data': 'contract.auction',
                    'visible': false
                },
                {
                    'name': 'multi-item',
                    'data': 'contract.multi_item',
                    'visible': false
                },
                {
                    'name': 'has_plex',
                    'data': 'contract.price.plex',
                    'visible': false,
                    'render': function (data, type, row, meta) {
                        return data > 0;
                    }
                },
            ],
            "order": [[1, "asc"]],
            "initComplete": function(settings, json) {
                for (i = 0; i < attr_list.length; i++) {
                    at = attr_list[i];
                    data = table
                        .column(`attr-${at}:name`)
                        .data()
                        .map(function (n) { return n.real_value; })
                        .sort(function (a, b) { return a - b; });

                    attr_val[at] = [data[0], data.reverse()[0]];
                    attr_val[at][0] -= (attr_val[at][0] < 0 ? -1 : 1) * attr_val[at][0] * 0.01;
                    attr_val[at][1] += (attr_val[at][1] < 0 ? -1 : 1) * attr_val[at][1] * 0.01;

                    column_ids[at] = table.column(`attr-${at}:name`).index();
                }

                data = table
                    .column("price:name")
                    .data()
                    .map(function (n) { return parseFloat(n.price.total); })
                    .sort(function (a, b) { return a - b; });

                attr_val["price"] = [0, data.reverse()[0] * 1.001];
                price_range = attr_val["price"];

                column_ids["price"] = table.column("price:name").index();
                column_ids["auction"] = table.column("auction:name").index();
                column_ids["multi-item"] = table.column("multi-item:name").index();
                column_ids["has_plex"] = table.column("has_plex:name").index();

                table.draw();
                update_labels();

                for (i = 0; i < attr_list.length; i++) {
                    initialize_slider(attr_list[i]);
                }
                initialize_slider("price");

                $.fn.dataTable.ext.search.push(
                    function (settings, data, dataIndex) {
                        var value, at;

                        for (i = 0; i < attr_list.length; i++) {
                            at = attr_list[i];

                            value = data[column_ids[at]];

                            if (value < attr_val[at][0] || value > attr_val[at][1]) {
                                return false;
                            }
                        }

                        value = data[column_ids["price"]];

                        if (value < attr_val["price"][0] || value > attr_val["price"][1]) {
                            return false;
                        }

                        if (!$("[name=filter-show-auctions]").is(":checked") && data[column_ids['auction']] == "true") {
                            return false;
                        }

                        if (!$("[name=filter-show-multi-item]").is(":checked") && data[column_ids['multi-item']] == "true") {
                            return false;
                        }

                        if (!$("[name=filter-show-plex]").is(":checked") && data[column_ids['has_plex']] == "true") {
                            return false;
                        }

                        return true;
                    }
                );
            }
        });


    });

    function price_humanize(price) {
        if (price > 1000000000) {
            return (price / 1000000000).toFixed(1) + "b"
        } else {
            return (price / 1000000).toFixed(0) + "m"
        }
    }

    function price_humanize_verbose(price) {
        if (price > 1000000000) {
            return (price / 1000000000).toFixed(1) + " billion"
        } else {
            return (price / 1000000).toFixed(1) + " million"
        }
    }

    function get_precision(attr_id) {
        if (attr_id == 64) {
            return 3;
        } else if (attr_id == "price") {
            return 0;
        } else if (attr_id == 105) {
            return 0;
        } else if (attr_id == 54) {
            return 0;
        } else {
            return 1;
        }
    }

    function update_labels() {
        for (i = 0; i < attr_list.length; i++) {
            at = attr_list[i];

            $(`#attr-${at}-min`).val(attr_val[at][0].toFixed(get_precision(at)));
            $(`#attr-${at}-max`).val(attr_val[at][1].toFixed(get_precision(at)));
        }

        $("#attr-price-min").text(price_humanize(attr_val["price"][0]));
        $("#attr-price-max").text(price_humanize(attr_val["price"][1]));
    }

    function attr_slider_fun(event, ui, attr_id) {
        attr_val[attr_id] = ui.values;
    }

    function price_slider_fun(event, ui, attr_id) {
        var min = ui.values[0] ** 3 * (price_range[1] / (1000 ** 3)) + price_range[0]
        var max = ui.values[1] ** 3 * (price_range[1] / (1000 ** 3)) + price_range[0]
        attr_val[attr_id] = [min, max];
    }

    function initialize_slider(attr_id) {
        var range;
        var values;
        var slide;

        if (attr_id == "price") {
            range = [0, 1000];
            values = [0, 1000];
            slide = price_slider_fun;
        } else {
            range = attr_val[attr_id];
            values = attr_val[attr_id];
            slide = attr_slider_fun;
        }

        $("#attr-" + attr_id + "-range").slider({
            range: true,
            min: range[0],
            max: range[1],
            step: Math.pow(10, -(get_precision(attr_id))),
            values: values,
            slide: function (event, ui) {
                slide(event, ui, attr_id);
                update_labels();
            },
            change: function (event, ui) {
                slide(event, ui, attr_id);
                update_labels();
                table.draw();
            }
        });
    }


</script>
{% endblock %}
