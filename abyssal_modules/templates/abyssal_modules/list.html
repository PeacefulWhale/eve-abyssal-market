{% extends 'base.html' %}
{% load humanize %}
{% load cache %}
{% load static %}
{% load module_stats %}

{% block title %}{{ module_type.name }}{% endblock %}

{% block content %}

<style>
    {% for at in attributes %}
    .attr-{{ at.id }}:after {
        content: " {{ at.unit_str }}";
    }
    {% endfor %}

    .attr-price:after {
        content: " ISK";
    }

    .price-field:after {
        content: " ISK "
    }

    .annotation-multi-item:after {
        content: "M"
    }

    .annotation-auction:after {
        content: "A"
    }
</style>

<div class="jumbotron">
    <h1>{{ module_type.name }}</h1>

    <form>
        <div class="row">
            <div class="form-group col-12 col-md-6">
                <div class="row">
                    <label class="col-6"><img src="{% static "img/attributes/price.png" %}" title="Price"> Price</label>
                    <span class="col-3 attr-price" id="attr-price-min"></span>
                    <span class="col-3 attr-price" id="attr-price-max"></span>
                </div>
                <div id="attr-price-range" class="slider-neutral"></div>
            </div>
            {% for at in attributes %}
            <div class="form-group col-12 col-md-6">
                <div class="row">
                    <label class="col-6"><img src="{% static at.icon_path %}" title="{{ at.name }}"> {{ at.name }}{% if at.derived %}<span style="text-muted" title="This is a derived attribute.">*</span>{% endif %}</label>
                    {% if at.high_is_good %}
                    <span class="col-3 attr-{{ at.id }} range-min" id="attr-{{ at.id }}-min"></span>
                    <span class="col-3 attr-{{ at.id }} range-max" id="attr-{{ at.id }}-max"></span>
                    {% else %}
                    <span class="col-3 attr-{{ at.id }} range-max" id="attr-{{ at.id }}-min"></span>
                    <span class="col-3 attr-{{ at.id }} range-min" id="attr-{{ at.id }}-max"></span>
                    {% endif %}
                </div>
                <div id="attr-{{ at.id }}-range" class="slider-{{ at.high_is_good|yesno:'positive,negative' }}"></div>
            </div>
            {% endfor %}
        </div>
        <br>
        <div class="row">
            <div class="col-6">
                <input type="checkbox" name="filter-show-auctions" class="update-filter" checked> Show auctions
            </div>
            <div class="col-6">
                <input type="checkbox" name="filter-show-multi-item" class="update-filter" checked> Show multi-item contracts
            </div>
        </div>
    </form>
</div>

<div class="jumbotron">
    <table class="table module-table dt-responsive" id="module-table">
        <thead>
            <tr>
                <th width="1px" data-orderable="false">Icon</th>
                {% for at in attributes %}
                <th data-priority="10500" data-name="attr-{{ at.id }}" data-type="num"><img src="{% static at.icon_path %}" title="{{ at.name }}"></th>
                {% endfor %}
                <th width="120px" data-name="price">Price</th>
                <th data-priority="9500" width="1px" data-orderable="false">Open</th>
                <th data-visible="false" data-name="auction" class="d-none">Auction</th>
                <th data-visible="false" data-name="multi-item" class="d-none">Multi-item</th>
                <th data-visible="false" data-name="true-price" class="d-none">True Price</th>
            </tr>
        </thead>
        {% cache 900 module_list module_type.id %}
        <tbody>
            {% for m in modules %}
            <tr>
                <td><a href="{% url 'abyssal_modules:module_view' m.id %}"><img src="https://image.eveonline.com/Type/{{ m.type.id }}_32.png"></a></td>
                {% for a in attributes %}
                <td class="attr-{{ a.id }}">{{ m|format_attribute:a.id }}</td>
                {% endfor %}
                <td data-sort="{{ m.contract_price }}">
                    <span class="price-field">{{ m.contract_price|intword }}</span><!--
                    -->{% if not m.contract_single %}<span class="annotation-multi-item text-muted" title="This contract includes other items."></span>{% endif %}<!--
                    -->{% if m.contract_auction %}<span class="annotation-auction text-muted" title="This is an auction. Price may be delayed by up to 30 minutes."></span>{% endif %}
                </td>
                <td class="contract-button-container">
                    <button
                        class="btn btn-primary btn-open-contract-esi btn-open-contract"
                        data-contract-id="{{ m.contract_id }}"
                    >
                        ESI
                    </button>&nbsp;
                    <button
                        class="btn btn-primary btn-copy btn-copy-contract-link btn-open-contract"
                        data-clipboard-text="<url=contract:30000142//{{ m.contract_id }}>Contract {{ m.contract_id }}</url>"
                    >
                        Link
                    </button>&nbsp;
                    <button
                        class="btn btn-primary btn-copy"
                        data-clipboard-text="{{ m.get_pyfa_string }}"
                    >
                        Pyfa
                    </button>
                </td>
                <td class="d-none">{{ m.contract_auction|yesno:"1,0" }}</td>
                <td class="d-none">{{ m.contract_single|yesno:"0,1" }}</td>
                <td class="d-none">{{ m.contract_price }}</td>
            </tr>
            {% endfor %}
        </tbody>
        {% endcache %}
    </table>
</div>
{% endblock %}

{% block trailing_js %}
<script>
    var table;
    var attr_val = {};
    var column_ids = {};
    var price_range;

    $(".update-filter").change(function () {
        table.draw();
    });

    $(document).ready(function () {
        {% if not request.user.is_authenticated %}
        $('.btn-open-contract-esi').prop('disabled', true);
        {% endif %}

        table = $('#module-table').DataTable({
            "order": [[1, "asc"]]
        });

        {% for at in attributes %}
        data = table
            .column("attr-{{ at.id }}:name")
            .data()
            .map(function (n) { return parseFloat(n); })
            .sort(function (a, b) { return a - b; });

        attr_val[{{ at.id }}] = [data[0], data.reverse()[0]],
        column_ids[{{ at.id }}] = table.column("attr-{{ at.id }}:name").index();
        {% endfor %}

        data = table
            .column("true-price:name")
            .data()
            .map(function (n) { return parseFloat(n); })
            .sort(function (a, b) { return a - b; });

        attr_val["price"] = [data[0], data.reverse()[0]];
        price_range = attr_val["price"];
        column_ids["price"] = table.column("price:name").index();
        column_ids["true-price"] = table.column("true-price:name").index();

        column_ids["auction"] = table.column("auction:name").index();
        column_ids["multi-item"] = table.column("multi-item:name").index();

        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                {% for at in attributes %}
                var value = data[column_ids[{{ at.id }}]];

                if (value < attr_val[{{ at.id }}][0] || value > attr_val[{{ at.id }}][1]) {
                    return false;
                }
                {% endfor %}

                var value = data[column_ids["true-price"]];

                if (value < attr_val["price"][0] || value > attr_val["price"][1]) {
                    return false;
                }

                if (!$("[name=filter-show-auctions]").is(":checked") && data[column_ids['auction']] == 1) {
                    return false;
                }

                if (!$("[name=filter-show-multi-item]").is(":checked") && data[column_ids['multi-item']] == 1) {
                    return false;
                }

                return true;
            }
        );

        table.draw();
        update_labels();

        {% for at in attributes %}
        initialize_slider({{ at.id }});
        {% endfor %}
        initialize_slider("price");
    });

    function price_humanize(price) {
        if (price > 1000000000) {
            return (price / 1000000000).toFixed(1) + "b"
        } else {
            return (price / 1000000).toFixed(0) + "m"
        }
    }

    function get_precision(attr_id) {
        if (attr_id == 64) {
            return 3;
        } else if (attr_id == "price") {
            return 0;
        } else if (attr_id == 105) {
            return 0;
        } else {
            return 1;
        }
    }

    function update_labels() {
        {% for at in attributes %}
        $("#attr-{{ at.id }}-min").text(attr_val[{{ at.id }}][0].toFixed(get_precision({{ at.id }})));
        $("#attr-{{ at.id }}-max").text(attr_val[{{ at.id }}][1].toFixed(get_precision({{ at.id }})));
        {% endfor %}

        $("#attr-price-min").text(price_humanize(attr_val["price"][0]));
        $("#attr-price-max").text(price_humanize(attr_val["price"][1]));
    }

    function attr_slider_fun(event, ui, attr_id) {
        attr_val[attr_id] = ui.values;
    }

    function price_slider_fun(event, ui, attr_id) {
        var min = ui.values[0] ** 3 * (price_range[1] / (1000 ** 3)) + price_range[0]
        var max = ui.values[1] ** 3 * (price_range[1] / (1000 ** 3)) + price_range[0]
        attr_val[attr_id] = [min, max];
    }

    function initialize_slider(attr_id) {
        var range;
        var values;
        var slide;

        if (attr_id == "price") {
            range = [0, 1000];
            values = [0, 1000];
            slide = price_slider_fun;
        } else {
            range = attr_val[attr_id];
            values = attr_val[attr_id];
            slide = attr_slider_fun;
        }

        $("#attr-" + attr_id + "-range").slider({
            range: true,
            min: range[0],
            max: range[1],
            step: Math.pow(10, -(get_precision(attr_id))),
            values: values,
            slide: function (event, ui) {
                slide(event, ui, attr_id);
                table.draw();
                update_labels();
            }
        });
    }


</script>
{% endblock %}
