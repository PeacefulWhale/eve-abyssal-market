{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% block content %}

<style>
    {% for at in attributes %}
    .attr-{{ at.id }}:after {
        content: " {{ at.unit_str }}";
    }
    {% endfor %}
</style>

<div class="jumbotron">
    <h1>{{ module_type.name }}</h1>

    <form>
        <div class="row">
        {% for at in attributes %}
            <div class="form-group col-6">
                <div class="row">
                    <label class="col-6"><img src="{% static at.icon_path %}" title="{{ at.name }}"> {{ at.name }}</label>
                    {% if at.high_is_good %}
                    <span class="col-3 attr-{{ at.id }} range-min" id="attr-{{ at.id }}-min"></span>
                    <span class="col-3 attr-{{ at.id }} range-max" id="attr-{{ at.id }}-max"></span>
                    {% else %}
                    <span class="col-3 attr-{{ at.id }} range-max" id="attr-{{ at.id }}-min"></span>
                    <span class="col-3 attr-{{ at.id }} range-min" id="attr-{{ at.id }}-max"></span>
                    {% endif %}
                </div>
                <div id="attr-{{ at.id }}-range" class="slider-{{ at.high_is_good|yesno:'positive,negative' }}"></div>
            </div>
        {% endfor %}
        </div>
    </form>
</div>

<div class="jumbotron">
    <table class="table module-table" id="module-table">
        <thead>
            <tr>
                <th width="1px">Icon</th>
                {% for at in attributes %}
                <th><img src="{% static at.icon_path %}" title="{{ at.name }}"></th>
                {% endfor %}
                <th width="100px">Price</th>
                <th width="1px">Open</th>
            </tr>
        </thead>
        <tbody>
            {% for m in modules %}
            <tr>
                <td><a href="{% url 'abyssal_modules:module_view' m.id %}"><img src="https://image.eveonline.com/Type/{{ m.type.id }}_32.png"></a></td>
                {% for a in m.attribute_list %}
                <td class="attr-{{ a.attribute.id }}">
                    {{ a.real_value|floatformat }}
                </td>
                {% endfor %}
                <td data-sort="{{ m.contract_price }}">{{ m.contract_price|intword }} ISK</td>
                <td class="contract-button-container">
                    <button
                        class="btn btn-primary btn-open-contract-esi btn-open-contract"
                        data-contract-id="{{ m.contract_id }}"
                        {% if not request.user.is_authenticated %}disabled{% endif %}
                    >
                        ESI
                    </button>&nbsp;
                    <button
                        class="btn btn-primary btn-copy-contract-link btn-open-contract"
                        data-clipboard-text="<url=contract:30000142//{{ m.contract_id }}>Contract {{ m.contract_id }}</url>"
                    >
                        Link
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block trailing_js %}
<script>
    $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
            {% for at in attributes %}
            var value = data[1 + {{ forloop.counter0 }}];

            if (value <= attr_val[{{ at.id }}][0] || value >= attr_val[{{ at.id }}][1]) {
                return false;
            }
            {% endfor %}

            return true;
        }
    );

    var attr_val = {
        {% for at in attributes %}
        {{ at.id }}: [{{ at.min_val }}, {{ at.max_val }}],
        {% endfor %}
    }

    var table;

    $(document).ready(function () {
        table = $('#module-table').DataTable({
            "columnDefs": [
                { "orderable": false, "targets": 0 }
            ],
            "order": [[1, "asc"]]
        });

        update_labels();
    });

    function update_labels() {
        {% for at in attributes %}
        $("#attr-{{ at.id }}-min").text(attr_val[{{ at.id }}][0].toFixed(1));
        $("#attr-{{ at.id }}-max").text(attr_val[{{ at.id }}][1].toFixed(1));
        {% endfor %}
    }

    {% for at in attributes %}
        $(function () {
            $("#attr-{{ at.id }}-range").slider({
                range: true,
                min: attr_val[{{ at.id }}][0],
                max: attr_val[{{ at.id }}][1],
                step: 0.01,
                values: attr_val[{{ at.id }}],
                slide: function (event, ui) {
                    attr_val[{{ at.id }}] = ui.values;
                    table.draw();
                    update_labels();
                }
            });
        });
    {% endfor %}
</script>
{% endblock %}
